<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    
        <script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>
    
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_a6410eb73840dad7c9d778df3dc9a8f6 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>
        
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.66.2/L.Control.Locate.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.66.2/L.Control.Locate.min.css"/>
</head>
<body>
    
    
<div style="position:fixed;top:0;left:0;right:0;z-index:1000;background:linear-gradient(135deg, #2c3e50, #3498db);padding:12px 20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
    <div style="max-width:1200px;margin:0 auto;color:white;text-align:center;">
        <h1 style="margin:0;font-size:22px;font-weight:600;letter-spacing:1.2px;text-shadow:1px 1px 2px rgba(0,0,0,0.3);">
            用戶變壓器地理資訊
        </h1>
        <p style="margin:5px 0 0;font-size:13px;opacity:0.95;">
            基於配電圖資new&CMMS建置｜僅供參考｜資料更新：2025-01-31 08:26
        </p>
    </div>
</div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
function escapeHTML(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

class MapLoader {
    constructor() {
        this._dataUrl = 'data/points.geojson';
        this._clusterGroups = new Map();
    }

    async init() {
        await this._loadData();
        this._initControls();
        this._addStyles();
    }

    async _loadData() {
        const response = await fetch(this._dataUrl);
        const geojson = await response.json();
        
        geojson.features.forEach(feature => {
            const feedLine = feature.properties.饋線;
            if (!this._clusterGroups.has(feedLine)) {
                this._createFeedLineGroup(feedLine, feature.properties.顏色代碼);
            }
            this._addMarker(feature, feedLine);
        });
    }

    _createFeedLineGroup(feedLine, color) {
        const group = {
            featureGroup: L.featureGroup(),
            markerCluster: L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: `<div style="
                            background:${color}70;
                            width:30px;
                            height:30px;
                            border-radius:50%;
                            border:2px solid rgba(255,255,255,0.8);
                            box-shadow:0 2px 6px rgba(0,0,0,0.3);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            color:white;
                            font-weight:bold;
                            font-size:16px;
                            ">${cluster.getChildCount()}</div>`,
                        className: 'marker-cluster'
                    });
                },
                maxClusterRadius: 40,
                disableClusteringAtZoom: 17
            })
        };
        group.markerCluster.addTo(group.featureGroup);
        group.featureGroup.addTo(map);
        this._clusterGroups.set(feedLine, group);
    }

    _addMarker(feature, feedLine) {
        const [lng, lat] = feature.geometry.coordinates;
        const props = feature.properties;
        
        const icon = L.divIcon({
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            html: `<div style="
                position:absolute;
                width:24px;
                height:24px;
                background:${props.顏色代碼};
                border-radius:50% 50% 50% 0;
                transform:rotate(-45deg);
                top:4px;
                left:4px;
                box-shadow:0 0 0 2px #FFF,
                          0 2px 4px rgba(0,0,0,0.2),
                          inset 0 -2px 2px rgba(0,0,0,0.1);">
                <div style="
                    position:absolute;
                    width:6px;
                    height:6px;
                    background:${props.顏色代碼};
                    border-radius:50%;
                    top:3px;
                    left:3px;">
                </div>
            </div>`
        });
        
        const popup = L.popup({ maxWidth: 300 }).setContent(`
            <div class="map-popup">
                <h4 class="popup-header" style="border-bottom-color:${props.顏色代碼}">${escapeHTML(props.設備名稱)}</h4>
                <div>
                    <p><b>座標:</b> ${escapeHTML(props.圖號座標)}</p>
                    <p><b>用戶數:</b> ${escapeHTML(props.用戶數)}</p>
                    <p><b>饋線:</b> <span style="color:${props.顏色代碼};">${escapeHTML(feedLine)}</span></p>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" 
                       target="_blank" class="nav-button" style="background:${props.顏色代碼}">🚗 開啟導航</a>
                </div>
            </div>
        ''');

        const marker = L.marker([lat, lng], { icon: icon }).bindPopup(popup);
        this._clusterGroups.get(feedLine).markerCluster.addLayer(marker);
    }

    _initControls() {
        const overlayLayers = {};
        this._clusterGroups.forEach((group, feedLine) => {
            overlayLayers[`饋線: ${feedLine}`] = group.featureGroup;
        });
        L.control.layers(null, overlayLayers, { position: 'topright' }).addTo(map);
    }

    _addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .map-popup {
                width: 280px;
                max-height: 300px;
                overflow: auto;
                font-family: 'Microsoft JhengHei', Arial, sans-serif;
                font-size: 14px;
                line-height: 1.5;
            }
            .popup-header {
                margin: 0 0 10px 0;
                padding-bottom: 5px;
                font-size: 18px;
            }
            .nav-button {
                display: block;
                padding: 8px;
                color: white !important;
                text-align: center;
                border-radius: 4px;
                margin-top: 10px;
                text-decoration: none;
            }
        `;
        document.head.appendChild(style);
    }
}

$(document).ready(() => {
    new MapLoader().init();
});
</script>
    
    
            <div class="folium-map" id="map_a6410eb73840dad7c9d778df3dc9a8f6" ></div>
        
</body>
<script>
    
    
            var map_a6410eb73840dad7c9d778df3dc9a8f6 = L.map(
                "map_a6410eb73840dad7c9d778df3dc9a8f6",
                {
                    center: [23.0467, 120.1842],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 12,
  "zoomControl": true,
  "preferCanvas": false,
}

                }
            );
            L.control.scale().addTo(map_a6410eb73840dad7c9d778df3dc9a8f6);

            

        
    
            var tile_layer_221c6e450a879fe6be66830435c92de7 = L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
  "minZoom": 0,
  "maxZoom": 18,
  "maxNativeZoom": 18,
  "noWrap": false,
  "attribution": "\u00a9 OpenStreetMap contributors",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_221c6e450a879fe6be66830435c92de7.addTo(map_a6410eb73840dad7c9d778df3dc9a8f6);
        
    
            var locate_control_60193179ba3048b7ec1b97766b3e631e = L.control.locate(
                {"position": "bottomright"}
            ).addTo(map_a6410eb73840dad7c9d778df3dc9a8f6);
            
        
</script>
</html>