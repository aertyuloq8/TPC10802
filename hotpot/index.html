
<!DOCTYPE html>
<html>
<head>
    <title>電號分佈熱力圖 & 點圖</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Marker Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet Search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.6/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@3.0.6/dist/leaflet-search.src.js"></script>

    <!-- Leaflet EasyPrint -->
    <script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>

    <style>
        #map { height: 800px; }
        .info.legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            font-size: 14px;
            line-height: 18px;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #999;
        }
    </style>
</head>
<body>
    <h2>電號分佈熱力圖 & 點圖</h2>
    <div id="map"></div>
    
    <script src="map_data.js"></script>

    <script>
        var map = L.map('map').setView([23.045608340363422, 120.19123596730388], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // 顏色清單
        var colorPalette = ["red", "blue", "green", "purple", "orange", "#6a0dad", "#009a00", "#ff1493", "#00ced1", "#8b4513"];
        var overlayMaps = {};
        var allPoints = [];
        var legendItems = [];

        // 建立 熱力圖 & 點圖
        var i = 0;
        for (const [prefix, coords] of Object.entries(data_dict)) {
            if (coords.length === 0) continue;
            var color = colorPalette[i % colorPalette.length];
            i++;

            // 熱力圖
            var heatLayer = L.heatLayer(coords, { radius: 25, blur: 15, gradient: {0.4: color, 0.65: color, 1.0: color} });
            overlayMaps[prefix + " 系列 (熱力圖)"] = heatLayer;
            map.addLayer(heatLayer);

            // 點圖 (Cluster)
            var markerCluster = L.markerClusterGroup();
            coords.forEach(function(c) {
                var marker = L.circleMarker(c, {
                    radius: 6,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7
                });
                markerCluster.addLayer(marker);
            });
            overlayMaps[prefix + " 系列 (點圖)"] = markerCluster;
            allPoints = allPoints.concat(coords);

            // 圖例
            legendItems.push({prefix: prefix, color: color});
        }

        // 加入圖層控制
        L.control.layers(null, overlayMaps).addTo(map);

        // 自動縮放
        if (allPoints.length > 0) {
            map.fitBounds(L.latLngBounds(allPoints));
        }

        // 標籤 & 搜尋資料
        var i = 0;
        var searchData = [];
        for (const [key, value] of Object.entries(label_positions)) {
            if (!isNaN(value.lat) && !isNaN(value.lon)) {
                var color = colorPalette[i % colorPalette.length];
                i++;
                var marker = L.marker([value.lat, value.lon], {
                    icon: L.divIcon({
                        className: 'regional-label',
                        html: '<div style="background-color: rgba(255,255,255,0.7); padding: 5px 10px; border-radius: 5px; border: 2px solid ' + color + '; font-weight: bold; font-size: 16px; color: ' + color + ';">' + key + '</div>',
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);
                searchData.push({loc:[value.lat, value.lon], title:key});
            }
        }

        // 圖例
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function () {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<h4>系列圖例</h4>';
            legendItems.forEach(function(item) {
                div.innerHTML += '<div class="legend-item"><div class="legend-color" style="background:' + item.color + ';"></div>' + item.prefix + '</div>';
            });
            return div;
        };
        legend.addTo(map);

        // 搜尋功能
        var searchControl = new L.Control.Search({
            layer: L.layerGroup(),
            propertyName: 'title',
            initial: false,
            zoom: 15,
            marker: false
        });
        searchControl._recordsCache = searchData.reduce((acc, item) => {
            acc[item.title] = item.loc;
            return acc;
        }, {});
        searchControl.on('search:locationfound', function(e) {
            map.setView(e.latlng, 15);
        });
        map.addControl(searchControl);

        // 匯出地圖 PNG
        L.easyPrint({
            title: '匯出地圖',
            position: 'topleft',
            sizeModes: ['A4Portrait', 'A4Landscape'],
            filename: 'map_export',
            exportOnly: true
        }).addTo(map);
    </script>
</body>
</html>
